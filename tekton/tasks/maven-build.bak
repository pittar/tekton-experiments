kind: Task
apiVersion: tekton.dev/v1alpha1
metadata:
  name: maven-build
spec:
  workspaces:
  - name: maven-repo
    description: Maven local repo dir.
    mountPath: /data/m2
  - name: maven-workspace
    description: Maven local repo dir.
    mountPath: /workspace/source
  inputs:
    params:
    - name: GOALS
      description: The Maven goals to run
      type: array
      default: ["clean", "package"]
    resources:
    - name: source
      type: git
  stepTemplate:
    envFrom:
    - secretRef:
        name: nexus-secret
  steps:
    - name: mvn-build
      image: maven:3.3.9-jdk-8
      workingDir: $(workspaces.maven-workspace.path)
      command: ["/usr/bin/mvn"]
      args:
        - -Dmaven.repo.local=$(workspaces.maven-repo.path)
        - -s
        - /var/mvn/settings.xml
        - "$(inputs.params.GOALS)"
      volumeMounts:
        - name: maven-settings
          mountPath: /var/mvn
    - name: sonar
      image: maven:3.3.9-jdk-8
      workingDir: $(workspaces.maven-workspace.path)
      command: ["/usr/bin/mvn"]
      args:
        - -Dmaven.repo.local=$(workspaces.maven-repo.path)
        - -s
        - /var/mvn/settings.xml
        - "sonar:sonar"
      volumeMounts:
        - name: maven-settings
          mountPath: /var/mvn
  volumes:
    - name: maven-settings
      configMap:
        name: maven-settings-cm
